---
title: "Land Cover Change Metrics Workflow"
author: "Jeronimo Rodriguez-Escobar"
output: html_document
---

---

This RMarkdown file shows how to:

1. Load land cover classification rasters and polygon units
2. E
2. Apply `extract_zonal_lcc_metrics()` and `iterate_zonal_lcc_metrics()`
3. Append the extracted metrics to the input polygon data.
4. Summarize and plot key land cover transition metrics


```{r setup, message=FALSE, warning=FALSE}
library(terra)
library(sf)
library(dplyr)
library(ggplot2)
library(glue)
library(tidyr)
library(purrr)
library(diffeR)
library(here)
# source the helper functions
source(here::here("R", "utils_lcc_metrics.R"))
source("R/utils_pct_change.R")
```

# Prepare data

Reclassify original LC maps into 
a) Simplified 9 class LC maps
b) Binary transformed/natural LC maps.


```{r load LC maps}
inpath <-  '/home/jeronimo/global_ES_modeling/esos-c/data/ndr'
tiffes <- file.path(inpath, list.files(paste0(inpath),pattern= 'landcover'))
filename<- basename(tiffes)
#set <- 'continent.gpkg' 

raster_list <- lapply(tiffes,rast)
num.cores <- length(raster_list)

# Define the reclassification rules in one operation
reclass_table <- data.frame(
  from = c(10, 11, 12, 20, 30, 40, 50, 60, 61, 62, 70, 71, 72, 80, 81, 82, 90, 100,
           110, 120, 121, 122, 130, 140, 150, 151, 152, 153, 160, 170, 180,
           190, 200, 201, 202, 210, 220),
  to = c(1, 1, 1, 1, 1, 1,   # Cultivated
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  # Forests
         3, 3, 3, 3, 3,   # Grasses and Shrubs
         4, 4, 4, 4, 4,   # Sparse Vegetation
         5, 5, 5,   # Mangroves
         6,   # Urban
         7, 7, 7,   # Bare
         8,   # Water
         9)   # Ice
)


raster_list <- lapply(raster_list, function(r) {
  subst(r, from = reclass_table$from, to = reclass_table$to)
})#,mc.cores = num.cores)

#save rasters 
lapply(1:length(raster_list), function(x) writeRaster(raster_list[[x]], paste0(here("input_ES", "LandCovers"),'/', filename[x])))

inpath <- here("input_ES", "LandCovers")

tiffes <- file.path(inpath, list.files(paste0(inpath),pattern= 'landcover'))
filename<- basename(tiffes)

raster_list <- lapply(tiffes,rast)

reclass_table <- data.frame(
  from = c(3,4,5,6,7,8,9),
  to = c(2,2,2,1,2,2,2)
)

raster_list <- lapply(raster_list, function(r) {
  subst(r, from = reclass_table$from, to = reclass_table$to)
})#,mc.cores = num.cores)

#save rasters 
lapply(1:length(raster_list), function(x) writeRaster(raster_list[[x]], paste0(here("input_ES", "LandCovers"),'/', "rec_", filename[x])))


# second reclassifciation Natural-not natural 

```

## Load Inputs

```{r load-data}
# Example file paths (replace with actual paths)
inpath <- here(here("input_ES","LandCovers"))
landcover_files <- list.files(
  inpath,
  pattern = "rec.*\\.tif$", 
  full.names = TRUE
)

# Name rasters by year
names(landcover_files) <- stringr::str_extract(basename(landcover_files), "\\d{4}")
landcover_rasters <- lapply(landcover_files, terra::rast)

# Load polygon spatial units (e.g., HydroBASINS level 6)

basins <- st_read(here("vector", "hydrosheds_lv6.gpkg"), layer= "lcc_change_metrics")
```

## Run Land Cover Change Metric Extraction

```{r run-extraction}

# iterate over multiple periods (>2)

lcc_metrics_df <- iterate_lcc_metrics(
  raster_list = landcover_rasters,
  polygons = basins,
  id_col = "HYBAS_ID",
  percent = TRUE,
  verbose = TRUE,
  mc = TRUE,
  ncores = 12,
  digits = 4
)

lcc_metrics_wide <- lcc_metrics_df %>%
  tidyr::pivot_wider(
    id_cols = c(cols[1]),
    names_from = c(Category, year_step),
    values_from = c(Gain, Persistence, Loss, Quantity, Exchange, Shift),
    names_glue = "{.value}_{Category}_{year_step}"
  )
# Note: there is something fishy going on here, the last run for 1992-2020 had some issues, when. iterating, but just running extract_lcc_metrics() without wrapping it for multiple time steps ( i need a technical way to refer to this) did solve the issue. Pending to check in the multi temporal assesment. 
# when doing thjat, keep two things presnet: set the number of digits to 4, add the column with the *direction* of change. For now, Shift is not necessary, possibly several columns are not needed at this point (especially those about Overall, ther is a lot of redudancy, it is *literarolly like balancing a budget. In fact, this is called a budget) Add the new column, but make sure to limit the number of digits, to 4. I am not sure if more digits make sense, and also, this results in a huge file. No need.
# Remove service change attributes from poly (btw, to avoid this is we can save each appended dataset as a new layer in the geopackage)

basins <- basins[c(1:13)]

##################################################
# Run the function with only two dates 
lcc_m2 <- extract_lcc_metrics(landcover_rasters[[1]], landcover_rasters[[2]], basins, "HYBAS_ID", percent=TRUE, mc = TRUE, ncores = 10, digits = 4)
# get qunatiy in terms of gain loss (the function does not provide the direction of the change, only the absolute value. 
lcc_m2 <- lcc_m2 %>%
  mutate(dir_ch = round(Gain - Loss, digits = 4)) # we set the number of dits to 4 to make te file more manageable


lcc_metrics_wide <- lcc_m2 %>%
  tidyr::pivot_wider(
    id_cols = c(cols[1]),
    names_from = c(Category),
    values_from = c(Gain, Persistence, Loss, Quantity, Exchange, dir_ch),
    names_glue = "{.value}_{Category}" #_{year_step}"
  )

# Convert both to character, just to be safe
basins <- basins %>% mutate(HYBAS_ID = as.character(HYBAS_ID))
lcc_metrics_wide <- lcc_metrics_wide %>% mutate(HYBAS_ID = as.character(HYBAS_ID))

basins <- left_join(basins, lcc_metrics_wide)

sf::st_write(basins,"/Users/rodriguez/Library/CloudStorage/OneDrive-WorldWildlifeFund,Inc/global_NCP/vector/hydrosheds_lv6.gpkg", layer = "1992_2020_lcc_change_metrics", append = FALSE)
sf::st_write(basins, here("vector", "hydrosheds_lv6.gpkg"), layer = "1992_2020_lcc_change_metrics", append = FALSE)
```

## Inspect Results

```{r summarize-results}
# Summarize by year and metric
summary_df <- lcc_metrics_df %>%
  group_by(year_step, Category) %>%
  summarize(across(c(Gain, Persistence, Loss, Quantity, Exchange, Shift), 
                   mean, na.rm = TRUE), .groups = "drop")

# Preview
head(summary_df)
```


```{r produce reference for the attributes}

# Extract column names (excluding ID column)
col_names <- names(lcc_metrics_wide)[!names(lcc_metrics_wide) %in% c("HYBAS_ID")]

# Parse components from column names using regex
ref_df <- tibble(
  column_name = col_names
) %>%
  mutate(
    component = str_extract(column_name, "^(Gain|Persistence|Loss|Quantity|Exchange|Shift)"),
    class = case_when(
      str_detect(column_name, "_1_") ~ "Transformed (class 1)",
      str_detect(column_name, "_2_") ~ "Natural (class 2)",
      str_detect(column_name, "_Overall_") ~ "Overall change",
      TRUE ~ "Unknown"
    ),
    year_step = str_extract(column_name, "[0-9]{4}_[0-9]{4}"),
    description = paste(component, "for", class, "during", year_step)
  )

# Optional: arrange for readability
ref_df <- ref_df %>% select(column_name, description)



```
## Plot Change Metrics Over Time

```{r plot-changes}
ggplot(summary_df, aes(x = year_step, y = Gain, group = Category, color = Category)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Average Gain in Transformed vs Natural Land Over Time",
       x = "Year Step",
       y = "% Area Changed") +
  theme_minimal()
```


