---
title: "LC Reclassify"
output: html_notebook
---


Here i am creating my maps of land cover change. Just from natuiral to tramnsformed. As usual, this is easier said thatn done


```{r load LC maps}
inpath <-  '/home/jeronimo/global_ES_modeling/esos-c/data/ndr'
tiffes <- file.path(inpath, list.files(paste0(inpath),pattern= 'landcover'))
filename<- basename(tiffes)
#set <- 'continent.gpkg' 

raster_list <- lapply(tiffes,rast)
num.cores <- length(raster_list)

# Define the reclassification rules in one operation
reclass_table <- data.frame(
  from = c(10, 11, 12, 20, 30, 40, 50, 60, 61, 62, 70, 71, 72, 80, 81, 82, 90, 100,
           110, 120, 121, 122, 130, 140, 150, 151, 152, 153, 160, 170, 180,
           190, 200, 201, 202, 210, 220),
  to = c(1, 1, 1, 1, 1, 1,   # Cultivated
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  # Forests
         3, 3, 3, 3, 3,   # Grasses and Shrubs
         4, 4, 4, 4, 4,   # Sparse Vegetation
         5, 5, 5,   # Mangroves
         6,   # Urban
         7, 7, 7,   # Bare
         8,   # Water
         9)   # Ice
)


raster_list <- lapply(raster_list, function(r) {
  subst(r, from = reclass_table$from, to = reclass_table$to)
})#,mc.cores = num.cores)

#save rasters 
lapply(1:length(raster_list), function(x) writeRaster(raster_list[[x]], paste0(here("input_ES", "LandCovers"),'/', filename[x])))

inpath <- here("input_ES", "LandCovers")

tiffes <- file.path(inpath, list.files(paste0(inpath),pattern= 'landcover'))
filename<- basename(tiffes)

raster_list <- lapply(tiffes,rast)


reclass_table <- data.frame(
  from = c(3,4,5,6,7,8,9),
  to = c(2,2,2,1,2,2,2)
)

raster_list <- lapply(raster_list, function(r) {
  subst(r, from = reclass_table$from, to = reclass_table$to)
})#,mc.cores = num.cores)

#save rasters 
lapply(1:length(raster_list), function(x) writeRaster(raster_list[[x]], paste0(here("input_ES", "LandCovers"),'/', "rec_", filename[x])))


# second reclassifciation Natural-not natural 

```



```{r landcover_differ_change, message=TRUE, warning=FALSE, eval=FALSE}

library(terra)
library(sf)
library(diffeR)
library(dplyr)
library(tidyr)
library(purrr)
library(progress)

# 1. Define inputs ----

# Path to input rasters
raster_dir <- here("input_landcover")
raster_files <- list.files(raster_dir, pattern = "\\.tif$", full.names = TRUE)

# Sort chronologically (assuming names contain 4-digit years)
raster_files <- raster_files[order(gsub("\\D", "", basename(raster_files)))]
years <- gsub("\\D", "", basename(raster_files))

# Load reclassified land cover rasters
lc_rasters <- lapply(raster_files, terra::rast)

# Load spatial units
polygons <- vect(here("vector", "hydrosheds_lev6.gpkg"))  # or lev7

# Ensure proper alignment
lc_rasters <- lapply(lc_rasters, function(r) terra::project(r, crs(polygons)))

# 2. Function to extract diffeR metrics per polygon and year ----

extract_differ_metrics <- function(poly, lc_list, years) {
  n_years <- length(lc_list)
  results <- list()

  for (i in 1:(n_years - 1)) {
    r1 <- lc_list[[i]]
    r2 <- lc_list[[i + 1]]
    year_pair <- paste0(years[i + 1], "_", years[i])

    # Crop/mask to polygon on-the-fly
    r1_crop <- crop(r1, poly) |> mask(poly)
    r2_crop <- crop(r2, poly) |> mask(poly)

    # Skip if empty
    if (is.na(global(r1_crop, fun = "sum", na.rm = TRUE))) next

    # Crosstab and difference metrics
    tab <- crosstabm(comp = r1_crop, ref = r2_crop, percent = TRUE)
    diff_stats <- difftablej(tab, analysis = "change")

    # Format result
    diff_stats$fid <- poly$HYBAS_ID
    diff_stats$year_step <- year_pair
    results[[length(results) + 1]] <- diff_stats
  }

  bind_rows(results)
}

# 3. Iterate over all polygons with progress bar ----

pb <- progress_bar$new(
  total = nrow(polygons),
  format = "  Processing [:bar] :percent in :elapsed",
  clear = FALSE, width = 60
)

all_results <- map_dfr(1:nrow(polygons), function(i) {
  pb$tick()
  extract_differ_metrics(polygons[i, ], lc_rasters, years)
})

# 4. Clean and export ----

# Pivot to long format
diff_long <- all_results %>%
  pivot_longer(cols = c("Gain", "Persistence", "Loss", "Quantity", "Exchange", "Shift"),
               names_to = "metric", values_to = "value")

# Export table for plotting or analysis
write.csv(diff_long, here("output_data", "lc_change_metrics.csv"), row.names = FALSE)


```

