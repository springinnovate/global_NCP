---
title: "Hotspot Intensity Analysis"
subtitle: "Quantifying the spatial extent of global hotspots"
author: "Jerónimo Rodríguez Escobar"
date: last-modified
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
editor: source
---

## Overview

This notebook quantifies the spatial extent and concentration of global hotspots across different spatial units (e.g., Regions, Biomes, Income Groups). It calculates three key metrics:

1.  **Hotspot Intensity (Coverage)**: The percentage of land area within a spatial unit that is classified as a hotspot.
2.  **Global Share (Distribution)**: The proportion of all global hotspot pixels that are located within a specific spatial unit.
3.  **Enrichment**: A ratio comparing the observed share of hotspots to the expected share based on land area (Observed / Expected). Values > 1 indicate that a region is disproportionately affected by hotspots relative to its size.

## Setup

```{r}
#| label: setup
#| message: false
#| warning: false

library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
library(devtools)

# Initialize paths and load project functions
knitr::opts_knit$set(root.dir = here::here())
source(here::here("R","paths.R"))
devtools::load_all(quiet = TRUE)

options(dplyr.summarise.inform = FALSE)
```


## Load Data

# Load the consolidated long-format data (`plt_long.rds`) generated by `hotspot_extraction.qmd`.
```{r}
#| label: load-data

rds_path <- file.path(data_dir(), "processed", "plt_long.rds")

if (file.exists(rds_path)) {
  message("Loading data from: ", rds_path)
  plt_long <- readRDS(rds_path)
} else {
  stop("plt_long.rds not found. Please run analysis/hotspot_extraction.qmd first to generate it.")
}

# Load the canonical grid (all grid cells, including those with NA for services)
gpkg_grid <- file.path(data_dir(), "processed", "10k_change_calc.gpkg")
if (file.exists(gpkg_grid)) {
  message("Loading canonical grid from: ", gpkg_grid)
  grid_df <- sf::st_read(gpkg_grid, quiet = TRUE)
  grid_df <- sf::st_drop_geometry(grid_df)
  # Filter out Antarctica and Seven Seas for consistency
  if ("continent" %in% names(grid_df)) {
    grid_df <- dplyr::filter(grid_df, !continent %in% c("Antarctica", "Seven seas (Open Ocean)"))
  }
  if (!"c_fid" %in% names(grid_df)) grid_df$c_fid <- grid_df$fid
} else {
  stop("Canonical grid file not found: ", gpkg_grid)
}
```

## Configuration

Using the standard hotspot definition rules.

```{r}
#| label: config

HOTS_CFG <- list(
  pct_cutoff      = 0.05,
  threshold_mode  = "percent",
  rule_mode       = "vectors",
  loss = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio"),
  gain = c("Sed_export","N_export","C_Risk"),
  groupings = c("income_grp","region_wb","continent","region_un","WWF_biome","nev_name"),
  svc_order = c(
    "C_Risk","N_export","Sed_export",
    "C_Risk_Red_Ratio","N_Ret_Ratio","Sed_Ret_Ratio",
    "Pollination","Nature_Access"
  )
)
```

## Analysis: Calculate Hotspot Intensity

```{r}
#| label: calc-intensity

# 1. Identify Global Hotspots
# We use the global scope to define what a "hotspot" is based on the full dataset distribution.
hs_global_obj <- extract_hotspots(
  df = plt_long,
  value_col = "pct_chg", # Using Percent Change as the primary metric
  pct_cutoff = HOTS_CFG$pct_cutoff,
  threshold_mode = HOTS_CFG$threshold_mode,
  rule_mode = HOTS_CFG$rule_mode,
  loss_services = HOTS_CFG$loss,
  gain_services = HOTS_CFG$gain,
  combos = NULL, # Focus on individual services
  id_cols = c("c_fid")
)

# 2. Flag Hotspot Pixels
hs_flags <- hs_global_obj$hotspots_df %>%
  dplyr::select(c_fid, service) %>%
  dplyr::mutate(is_hotspot = 1)

# Calculate global total hotspots per service (for "Share of Global" metric)
global_totals <- hs_flags %>%
  dplyr::count(service, name = "global_n_hot")


# 3. Calculate Coverage % per Grouping (using full grid for denominator)
valid_groupings <- intersect(HOTS_CFG$groupings, names(grid_df))
area_stats_list <- list()

# Services and regions to exclude from plots/stats
exclude_services <- c("C_Risk_NoHab", "USLE")
exclude_regions  <- c("Seven seas (Open Ocean)", "Seven seas (open ocean)", "Antarctica")


# For each grouping, bind all services together and store by grouping only
for (g in valid_groupings) {
  if (!g %in% names(grid_df)) next
  stats_all <- lapply(HOTS_CFG$svc_order, function(svc) {
    grid_svc <- grid_df %>%
      dplyr::select(c_fid, !!g) %>%
      dplyr::mutate(service = svc)
    grid_svc <- grid_svc %>%
      dplyr::left_join(hs_flags %>% dplyr::filter(service == svc), by = c("c_fid", "service")) %>%
      dplyr::mutate(is_hotspot = tidyr::replace_na(is_hotspot, 0))
    grid_svc <- grid_svc %>%
      dplyr::filter(!service %in% exclude_services) %>%
      dplyr::filter(!.data[[g]] %in% exclude_regions)
    grid_svc %>%
      dplyr::filter(!is.na(.data[[g]])) %>%
      dplyr::group_by(service, group = .data[[g]]) %>%
      dplyr::summarise(
        n_total = dplyr::n(),
        n_hot   = sum(is_hotspot),
        pct_area = (n_hot / n_total) * 100,
        .groups = "drop"
      )
  })
  stats <- dplyr::bind_rows(stats_all)
  stats <- stats %>%
    dplyr::left_join(global_totals, by = "service") %>%
    dplyr::group_by(service) %>%
    dplyr::mutate(
      pct_share = (n_hot / global_n_hot) * 100,
      grouping_var = g,
      # Expected share by area (area of unit / total area)
      expected_share = (n_total / sum(n_total)) * 100,
      # Enrichment: observed share / expected share
      enrichment = ifelse(expected_share > 0, pct_share / expected_share, NA)
    ) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(desc(pct_area))
  area_stats_list[[g]] <- stats
}

hotspot_area_stats <- dplyr::bind_rows(area_stats_list)

# Save summary table (now includes enrichment)
out_csv_path <- file.path(data_dir(), "processed", "hotspot_area_stats.csv")
readr::write_csv(hotspot_area_stats, out_csv_path)
message("Hotspot area statistics saved to: ", out_csv_path)

# Preview
head(hotspot_area_stats, 10)
```

## Visualization

```{r}
#| label: plot-intensity
#| message: false

plot_area_stats <- function(df, g_var, metric = "pct_area") {
  metric_label <- switch(metric,
    "pct_area" = "% Area is Hotspot (Intensity)",
    "pct_share" = "% Share of Global Hotspots (Distribution)",
    "enrichment" = "Hotspot Enrichment (Observed/Expected)",
    "% Area is Hotspot (Intensity)"
  )
  file_suffix  <- switch(metric,
    "pct_area" = "coverage",
    "pct_share" = "share",
    "enrichment" = "enrichment",
    "coverage"
  )

  d_plot <- df %>% dplyr::filter(grouping_var == g_var)

  # Ensure service order
  d_plot <- d_plot %>%
    dplyr::mutate(service = factor(service, levels = HOTS_CFG$svc_order)) %>%
    dplyr::filter(!is.na(service))

  # If no data, skip plotting and return NULL
  if (nrow(d_plot) == 0) {
    message("No data to plot for grouping: ", g_var, " and metric: ", metric)
    return(NULL)
  }

  # If there are many groups (e.g. countries), filter to top 15 per service
  n_groups <- dplyr::n_distinct(d_plot$group)
  is_large_group <- n_groups > 20


  if (is_large_group) {
    scales_val <- "free_y"
  } else {
    subtitle_add <- ""
    # Small groups: Shared Y axis, sorted alphabetically (A top)
    d_plot <- d_plot %>%
      dplyr::arrange(dplyr::desc(group)) %>%
      dplyr::mutate(group_ordered = factor(group, levels = unique(group)))
    scales_val <- "free_x"
  }

  p <- ggplot2::ggplot(d_plot, ggplot2::aes(x = .data[[metric]], y = group_ordered, fill = service)) +
    ggplot2::geom_col(show.legend = FALSE) +
    ggplot2::facet_wrap(~ service, scales = scales_val, ncol = 3) +
    ggplot2::labs(
      title = paste0("Hotspot ", if (metric == "pct_area") "Intensity" else if (metric == "enrichment") "Enrichment" else "Distribution", " by ", g_var),
      subtitle = paste0(metric_label, subtitle_add),
      x = metric_label, y = NULL
    ) +
    ggplot2::theme_minimal()

  # Add vertical dashed line at enrichment = 1 for enrichment plots (always, after plot is created)
  if (metric == "enrichment") {
    p <- p + ggplot2::geom_vline(xintercept = 1, linetype = "dashed", color = "black")
  }

  if (is_large_group) {
    p <- p + ggplot2::scale_y_discrete(labels = function(x) sub("___.*", "", x))
  }

  # Save plot
  out_file <- file.path(out_plots(), paste0("hotspot_", file_suffix, "_", tolower(g_var), ".png"))
  ggsave(out_file, p, width = 12, height = 8, bg = "white")
  message("Saved plot: ", out_file)
  return(p)
}

# Generate plots for all groupings
plots_intensity <- lapply(names(area_stats_list), function(g) plot_area_stats(hotspot_area_stats, g, "pct_area"))
plots_share     <- lapply(names(area_stats_list), function(g) plot_area_stats(hotspot_area_stats, g, "pct_share"))
plots_enrichment <- lapply(names(area_stats_list), function(g) plot_area_stats(hotspot_area_stats, g, "enrichment"))

# Display the first plot (e.g., Income Group)
if (length(plots_intensity) > 0) plots_intensity[[1]]
```