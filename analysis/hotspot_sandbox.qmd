---
title: "Hotspot Sandbox (experiments)"
subtitle: "Lightweight playground; mirror main configs, keep chunks off by default"
author: "Jerónimo Rodríguez Escobar"
format:
  html:
    toc: true
    number-sections: true
    code-fold: true
    theme: cosmo
editor: source
---

::: callout-warning
Use `analysis/hotspot_extraction.qmd` for the **canonical** run. This sandbox is for quick experiments (tweaking cutoffs, trying a different input, prototyping plots) without touching the main report. Heavy chunks are `eval: false` by default—flip them on when you actually need them.
:::

## Setup

```{r}
#| label: setup
#| message: false
#| warning: false
#| echo: false

library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)
library(here)

library(devtools)
source(here::here("R","paths.R"))
knitr::opts_knit$set(root.dir = here::here())
devtools::load_all(quiet = TRUE)

options(dplyr.summarise.inform = FALSE)
set.seed(1)
```

## Config (match main analysis)

```{r}
#| label: config
#| echo: true

`%||%` <- function(x, y) if (is.null(x)) y else x

HOTS_CFG <- list(
  pct_cutoff      = 0.05,
  threshold_mode  = "percent",
  rule_mode       = "vectors",
  loss_services   = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio"),
  gain_services   = c("Sed_export","N_export","C_Risk"),
  combos = list(
    deg_combo = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    rec_combo = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  ),
  svc_order = c(
    "C_Risk","N_export","Sed_export",
    "C_Risk_Red_Ratio","N_Ret_Ratio","Sed_Ret_Ratio",
    "Pollination","Nature_Access"
  ),
  include_services = NULL  # NULL = use all in svc_order
)
```

## Pivot to long (heavy; off by default)

Rebuild `plt_long` from `processed/10k_change_calc.gpkg`. Turn `eval: true` only if you need a fresh pivot here; otherwise, rely on the main report cache.

```{r}
#| label: pivot
#| eval: false
#| include: false
#| echo: false
#| results: hide
#| cache: true

gpkg <- file.path(data_dir(), "processed", "10k_change_calc.gpkg")
stopifnot(file.exists(gpkg))

sf_f <- sf::st_read(gpkg, quiet = TRUE)
if (!"fid" %in% names(sf_f)) sf_f$fid <- seq_len(nrow(sf_f))
plt <- sf::st_drop_geometry(sf_f)

id_cols  <- c("fid", "c_fid")
chg_cols <- grep("_(abs|pct)_chg$", names(plt), value = TRUE)
socio_vars <- setdiff(names(plt), c(id_cols, chg_cols))

plt_long <- plt |>
  tidyr::pivot_longer(
    cols = tidyselect::all_of(chg_cols),
    names_to = c("service", "chg_type"),
    names_pattern = "^(.*)_(abs|pct)_chg$",
    values_to = "chg_value"
  ) |>
  dplyr::mutate(service = stringr::str_remove(service, "_mean$")) |>
  tidyr::pivot_wider(
    names_from  = chg_type,
    values_from = chg_value,
    names_vary  = "slowest"
  ) |>
  dplyr::rename(abs_chg = abs, pct_chg = pct) |>
  dplyr::select(fid, c_fid, service, abs_chg, pct_chg, dplyr::any_of(socio_vars)) |>
  dplyr::filter(!is.na(c_fid)) |>
  dplyr::filter(!(is.infinite(abs_chg) | is.infinite(pct_chg))) |>
  dplyr::filter(!is.na(abs_chg) | !is.na(pct_chg))

service_lookup <- c(
  sed_export     = "Sed_export",
  n_export       = "N_export",
  n_retention    = "N_retention",
  nature_access  = "Nature_Access",
  pollination    = "Pollination",
  usle           = "USLE",
  n_ret_ratio    = "N_Ret_Ratio",
  sed_ret_ratio  = "Sed_Ret_Ratio",
  Rt_ratio       = "C_Risk_Red_Ratio",
  Rt             = "C_Risk",
  Rt_service     = "C_Prot_service",
  Rt_nohab       = "Rt_nohab"
)
plt_long <- plt_long |>
  dplyr::mutate(service = dplyr::recode(service, !!!service_lookup, .default = service))

extras <- setdiff(unique(plt_long$service), HOTS_CFG$svc_order)
plt_long <- plt_long |>
  dplyr::mutate(service = factor(service, levels = c(HOTS_CFG$svc_order, sort(extras))))
```

## Hotspot extraction (off by default)

Compute hotspots/non-hotspots using the same rules as the main analysis. Turn on when testing different cutoffs or data sources.

```{r}
#| label: extract-hotspots
#| eval: false
#| message: false
#| warning: false

svc_keep <- HOTS_CFG$include_services %||% levels(plt_long$service) %||% unique(plt_long$service)
hs <- extract_hotspots(
  df            = dplyr::filter(plt_long, service %in% svc_keep),
  value_col     = "pct_chg",
  pct_cutoff    = HOTS_CFG$pct_cutoff,
  threshold_mode= HOTS_CFG$threshold_mode,
  rule_mode     = HOTS_CFG$rule_mode,
  loss_services = HOTS_CFG$loss_services,
  gain_services = HOTS_CFG$gain_services,
  combos        = HOTS_CFG$combos,
  id_cols       = c("c_fid")
)

hotspots_df <- hs$hotspots_df
inverse_df  <- hs$non_hotspots_df
```

## Optional: hotspot vs non-hotspot scatters

Quick scatter/ECDF prototypes without touching the main report. Pick one variable, cap points for speed, and facet by top services.

```{r}
#| label: scatter-hot-vs-non
#| eval: false
#| message: false
#| warning: false

stopifnot(exists("hotspots_df"), exists("inverse_df"))

var_id <- "GHS_POP_E2020_GLOBE_sum"
top_k  <- 6
max_n  <- 20000  # cap rows per group for plotting speed

base <- dplyr::bind_rows(
  dplyr::mutate(hotspots_df, group = "hotspot"),
  dplyr::mutate(inverse_df,  group = "nonhotspot")
) |>
  dplyr::select(service, group, val = .data[[var_id]]) |>
  dplyr::filter(is.finite(val))

# pick top-K services by KS D for this var
find_D <- function(d) {
  x <- d$val[d$group=="hotspot"]; y <- d$val[d$group=="nonhotspot"]
  if (length(x) < 2 || length(y) < 2) return(NA_real_)
  suppressWarnings(as.numeric(stats::ks.test(x, y, exact = FALSE)$statistic))
}
top_services <- base |>
  dplyr::group_by(service) |>
  dplyr::summarise(D = find_D(dplyr::cur_data_all()), .groups = "drop") |>
  dplyr::arrange(dplyr::desc(D)) |>
  dplyr::slice_head(n = top_k) |>
  dplyr::pull(service)

dd <- dplyr::filter(base, service %in% top_services)
if (nrow(dd) > max_n) dd <- dd[sample.int(nrow(dd), max_n), , drop = FALSE]

ggplot(dd, aes(x = val, y = group, color = group)) +
  ggrepel::geom_jitter(height = 0.1, alpha = 0.2, size = 0.6, show.legend = FALSE) +
  facet_wrap(~ service, scales = "free_x") +
  scale_color_manual(values = c(nonhotspot = "#2D708E", hotspot = "#D43D51")) +
  labs(
    title = paste("Hotspot vs non-hotspot:", var_id),
    x = var_id, y = NULL
  ) +
  theme_minimal(base_size = 11)
```

Add any other experimental chunks below; keep paths/configs aligned with the main analysis.
