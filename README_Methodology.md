# Methodology: The Two-Path Analysis Structure

This document clarifies the dual-pathway approach used in the Global NCP project to analyze changes in ecosystem services between 1992 and 2020. Understanding this structure is crucial for interpreting the results, as summary statistics and hotspot analyses are derived from two distinct computational paths.

## The Two Paths

The analysis is split into two parallel workflows:

1.  **Path A (Pixel-Level Change):** For raw change summaries.
2.  **Path B (Grid-Level Change):** For hotspot identification and regional synthesis.

---

### Path A: Pixel-Level Change Calculation

This path is designed to generate summary statistics (e.g., Mean, Max, Min) based on the most granular change possible.

**Workflow:**

1.  **Pixel-wise Difference:** The script `Python_scripts/batch_raster_diff.py` takes the 1992 and 2020 rasters for a given service and calculates the difference (`T2020 - T1992`) for each corresponding pixel.
2.  **Output:** The result is a new set of "difference rasters" that represent the absolute change at the native resolution of the data.

**Use Case:** This path is used when a straightforward, non-aggregated summary of the overall change across the landscape is required.

### Path B: Grid-Level Change Calculation (The Hotspot Path)

This is the primary pathway for the main analysis, including hotspot identification and regional aggregation. The key distinction is that **aggregation precedes differencing**.

**Workflow:**

1.  **Independent Aggregation:** The script `summary_pipeline_landgrid.py` takes the raw 1992 and 2020 rasters and independently calculates zonal statistics for each of them against the canonical 10km grid. The output is a single table containing separate columns for the 1992 and 2020 values (e.g., `service_1992_mean`, `service_2020_mean`).
2.  **Grid-Level Differencing:** The Quarto notebook `analysis/process_data.qmd` ingests the aggregated table from the previous step. It then calculates the absolute and Symmetric Percentage Change (SPC) between the 1992 and 2020 columns for each grid cell.
3.  **Hotspot Identification:** The notebook `analysis/hotspot_extraction.qmd` takes the final grid-level change data and identifies hotspots.

**Use Case:** This path underpins all hotspot maps, regional summaries, and enrichment analyses.

---

## Why Might Results from Path A and Path B Differ?

The two paths may produce slightly different summary statistics due to a fundamental difference in the order of operations:

-   **Path A** calculates the **aggregate of the differences**.
-   **Path B** calculates the **difference of the aggregates**.

These are not always mathematically identical, especially when dealing with non-linear metrics or complex spatial distributions. The grid-based approach (Path B) is considered the canonical method for the hotspot analysis.

## Future Analysis: Quantifying Methodological Differences with Path C

To explicitly quantify the difference between the two methodologies, a third analytical path ("Path C") can be implemented. This path serves as a bridge, creating a spatially explicit grid based on the pixel-level differences.

**Workflow:**

1.  **Start with Path A Output:** Use the pixel-level "difference rasters" generated by `Python_scripts/batch_raster_diff.py`.
2.  **Aggregate the Difference:** Using a zonal statistics process, calculate statistics (e.g., `mean`, `sd`) for the pixel values from the difference raster within each 10km grid cell.

**Analytical Value:**

-   **Direct Comparison:** This creates a grid of the "aggregate of the differences," which can be directly compared to the Path B grid ("difference of the aggregates"). Subtracting one from the other would produce a map spatially visualizing the magnitude and location of the methodological divergence.
-   **Sub-Cell Variability:** By calculating the standard deviation (`sd`) in the aggregation step, we can also quantify the variability of change *within* each 10km cell. This could be used to add error bars to analyses or to identify areas of homogenous vs. heterogeneous change, adding valuable richness to the interpretation.

This approach provides the spatial representation of the pixel-based method while remaining computationally manageable, providing a robust framework for comparing the core methodologies.

## Key Analysis Parameters

-   **Hotspot Threshold:** The threshold for identifying hotspots is defined in `analysis/hotspot_extraction.qmd`. It is configured in an R object named `HOTS_CFG` with the parameter `pct_cutoff = 0.05`, representing the top/bottom 5% of SPC values.

## Aggregation Logic: Sum vs. Mean

A common question regarding Path B is the comparability of variables aggregated via **sum** (extensive variables like Nitrogen Export) versus those aggregated via **mean** (intensive variables like Risk Indices).

**Why this approach is robust:**

1.  **Physical Correctness:** It is physically correct to sum total loads and average representative conditions.
2.  **Equal-Area Grid:** The analysis uses the IUCN equal-area grid. Since cell area is constant, $Sum$ and $Mean$ are perfectly proportional ($Sum = Mean \times Area$).
3.  **Mathematical Identity:** For relative metrics used in this analysis (percent change, percentile rankings, KS test statistics), the results are identical regardless of whether sum or mean is used.
4.  **Comparability:** Comparing relative magnitudes of change (e.g., percentage change) strips away the units, allowing valid comparisons between total loads and average indices.
