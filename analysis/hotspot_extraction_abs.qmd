---
title: "Hotspot Extraction"
format: html
editor: visual
---

```{r setup, message=FALSE, warning=FALSE}
library(terra)
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(diffeR)
library(here)
library(stringr)
library(tidytext)
library(rlang)
library(tidyr)
library(forcats)
library(scales)
library(RColorBrewer)
library(htmltools)
library(leaflet)
library(devtools)
library(reticulate)
library(exactextractr)
library(httpgd)
library(ggnewscale)   # allows multiple fill scales
library(viridisLite)
library(ragg)
load_all()

#source the helper functions
# set venv focr Python
use_virtualenv("/home/jeronimo/venvs/coastal_snap_env", required = TRUE)
#inpath <- '/Users/rodriguez/Library/CloudStorage/OneDrive-WorldWildlifeFund,Inc/global_NCP/output_data'

```

####################### START HERE

# 1 Hotspot Extraction

## 1.1 Prepare Data for Analysis

The spatial objects with the additional attributes are loaded and reformatted for analysis and chart preparation, that requires to **pivot** the input vector files into the long format, with one row per service/cell combination.

```{r pivot}
#| eval: true
#| include: true
 inpath <- here("output_data")
 inpath <- '/home/jeronimo/OneDrive/PROJECTS/Global_NCP/Final_outputs'
#  get pct as standalone data to add to the table
# Most recent version of synthesis data:
#sf_f <- st_read(paste0(inpath, '/', '10k_grid_ES_change_benef_f.gpkg'))
lyr_sf <- st_layers("~/data/global_ncp/processed/10k_change_calc.gpkg")
sf_f <- st_read("~/data/global_ncp/processed/10k_change_calc.gpkg") 
sf_f <- sf_f[-33]
# rename column because, fixz later
sf_f <-sf_f %>% rename(c_fid=c_fid.x) 

#change names here (homogenize) 
#this as backup, remove as soon as possible.
#sf_f <- sf_f %>% mutate(fid=fid_2)
# add fid # THIS DOOES NOT WORK LIKE THIS!!!!!! DO NOT USE!!!
sf_f$fid <- seq_len(nrow(sf_f)) 
plt <- st_drop_geometry(sf_f)

# get the benef vars (all that are not "chg")
socio_vars <- names(plt)[
  names(plt) != c("fid", "c_fid") & 
  !grepl("chg$", names(plt))
]


# Pivot all columns that contain pct_ch, keeping other relevant vars

library(dplyr)
library(tidyr)
library(stringr)

# socio variables to carry through (adjust to your set)
socio_vars <- c(
  "GHS_BUILT_S_E2020_mean",
  "fields_mehrabi_2017_mean",
  "hdi_raster_predictions_2020_mean",
  "rast_adm1_gini_disp_2020_mean",
  "rast_gdpTot_1990_2020_30arcsec_2020_sum",
  "GHS_POP_E2020_GLOBE_sum",
  "GlobPOP_Count_30arc_2020_sum",
  "iso3","continent","income_grp","region_un","region_wb","subregion","BIOME","WWF_biome"
)

plt_long <- plt %>%
  # 1) Long pivot on *_abs_chg / *_pct_chg columns
  pivot_longer(
    cols = matches("_(abs|pct)_chg$"),
    names_to = c("service", "chg_type"),
    names_pattern = "^(.*)_(abs|pct)_chg$",
    values_to = "chg_value"
  ) %>%
  # OPTIONAL: normalize service labels if you want to drop a trailing "_mean"
  mutate(service = str_remove(service, "_mean$")) %>%
  # 2) Go wide so we get two columns: abs_chg, pct_chg
  pivot_wider(
    names_from = chg_type,
    values_from = chg_value,
    names_vary = "slowest"
  ) %>%
  # after pivot_wider we have columns "abs" and "pct" -> rename
  rename(abs_chg = abs, pct_chg = pct) %>%
  # 3) Reorder/select the columns you need
  select(
    fid, c_fid, service, abs_chg, pct_chg,
    any_of(socio_vars)
  ) %>%
  # 4) Filters (tweak as needed)
  filter(!is.na(c_fid), !is.na(iso3), !is.na(BIOME)) %>%
  filter(!(is.infinite(pct_chg) | is.infinite(abs_chg))) %>%
  # keep rows where at least one metric exists
  filter(!is.na(pct_chg) | !is.na(abs_chg))

# this should be updated on an earlier stage when i extract the data, not here)

  plt_long <- plt_long %>% mutate(service = case_when(
   service == "sed_export" ~ "Sed_export",
   service == "n_export" ~ "N_export",
   service == "n_retention" ~ "N_retention",
   service == "nature_access" ~ "Nature_Access",
   service == "pollination" ~ "Pollination",
   service == "usle" ~ "USLE",
   service == "n_ret_ratio" ~ "N_Ret_Ratio",
   service == "sed_ret_ratio" ~ "Sed_Ret_Ratio",
   service == "Rt_ratio" ~ "C_Risk_Red_Ratio",
   service == "Rt" ~ "C_Risk",
   service == "Rt_service" ~ "C_Prot_service",
   TRUE ~ service
   ))
  
  

# Set service levels one single time and for all. Don't drop some variables here, filter afterwards, it can be difficult/annoying to recover!!!
service_levels <- c("Nature_Access","N_export","N_retention", "N_Ret_Ratio", "Sed_export", "USLE", "Sed_Ret_Ratio", "Rt_nohab","C_Risk","C_Prot_service", "C_Risk_Red_Ratio", "Pollination") 

```

# Load country data

Load the data and select.

```{r load country gpkg}

# (0) Preconditions: `sf_f` is already in memory and cleaned
#     It must contain at least: fid (unique id), c_fid, and geometry (polygons)
stopifnot(inherits(sf_f, "sf"))
stopifnot(all(c("fid", "c_fid") %in% names(sf_f)))

# (1) Read country polygons (keep only needed columns)
ct <- st_read(
  "/home/jeronimo/data/global_ncp/vectors/cartographic_ee_ee_r264_correspondence.gpkg",
  quiet = TRUE
) |>
  select(id, ee_r264_name, iso3, continent, income_grp, region_un, region_wb, subregion)

# (2) Read biomes (WWF biomes), keep id & label columns only
biomes <- st_read(
  "/home/jeronimo/data/global_ncp/vectors/Biome.gpkg",
  quiet = TRUE
) |>
  select(BIOME, WWF_biome)

# (3) Harmonize CRS (transform both polygon layers to match the grid CRS)
crs_grid <- st_crs(sf_f)
if (st_crs(ct) != crs_grid)     ct     <- st_transform(ct, crs_grid)
if (st_crs(biomes) != crs_grid) biomes <- st_transform(biomes, crs_grid)

# (4) Build a lightweight template from the grid (only keys you need)
sf_template <- sf_f |>
  select(fid, c_fid) # keeps geometry (grid cells)

# (5) One representative point per cell (robust for concave polygons)
#     This is much faster/safer than polygon-on-polygon joins for attribution.
pts <- st_point_on_surface(sf_template)

# (6) Spatial join attributes onto points
#     NOTE: DO NOT drop geometry on `ct`/`biomes` before this step.
#     Keep defaults: left = TRUE (keeps all pts), largest = FALSE (strict within).
#     If you want "closest polygon" behavior, use `st_join(..., join = st_nearest_feature)`
pts_ct    <- st_join(pts, ct,     left = TRUE)
pts_biome <- st_join(pts, biomes, left = TRUE)

# (7) Drop point geometry to get a pure attribute table keyed by fid
pts_ctdf <- pts_ct    |> st_drop_geometry()
pts_bmdf <- pts_biome |> st_drop_geometry()

# (8) Merge country + biome attributes (both are 1 row per fid)
#     Keep suffixes clean in case of name collisions.
out_attrs <- pts_ctdf |>
  left_join(pts_bmdf, by = "fid", suffix = c("", "_biome"))

# (Optional) sanity: ensure uniqueness by `fid`
if (any(duplicated(out_attrs$fid))) {
  # If duplicates ever appear, collapse to first occurrence
  out_attrs <- out_attrs |>
    arrange(fid) |>
    distinct(fid, .keep_all = TRUE)
}

# (9) Bring attributes back to the original grid (preserve grid geometry)
sf_f_joined <- sf_f |>
  left_join(out_attrs, by = "fid")

# (10) Quick checks
stopifnot(nrow(sf_f_joined) == nrow(sf_f))
stopifnot(inherits(sf_f_joined, "sf"))

# (11) Write result (overwrite safely)
out_path <- "~/data/global_ncp/processed/10k_change_calc.gpkg"
if (file.exists(out_path)) file.remove(out_path)
st_write(sf_f_joined, out_path, quiet = TRUE)

```

```{r hotpots pct}


# Adjust This. Set the variables outside as they should:
## Define the intended direction of change (service loss/increased damage)
loss <- c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
gain <- c("Sed_export","N_export","C_Risk")

 combos = list(
    combo_1 = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    combo_2 = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  )
# after running:
hs <- extract_hotspots(
  df = plt_long,
  value_col = "abs_chg",
  pct_cutoff = 0.05,
  threshold_mode = "percent",
  rule_mode = "vectors",
  loss_services = loss,
  gain_services = gain,
  combos = list(
    deg_combo = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    rec_combo = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  ),
  id_cols = c("c_fid"),
  sf_obj = sf_f,                                       # sf with fid
  write_sf_path = "output_data/hotspots_abs_ch.gpkg",       
  write_driver  = "GPKG",                              
  clean_names   = TRUE,
  fid_alias     = "fid_2",                             # duplicate fid only for the file
  drop_fid_on_write = TRUE                             # drop original fid on disk (keep in memory)
)


#save(hs, file=here("output_data", "hotspots_5.RData")) 
# hotspots_sf <- st_read('/Users/rodriguez/OneDrive - World Wildlife Fund, Inc/global_NCP/output_data/hotspots_5_final.gpkg')
hp_sf <- hs$hotspots_sf
hp_sf <- hp_sf %>% select(-ends_with("_abs_chg"))
```

```{r hotpots abs}

# Adjust This. Set the variables outside as they shou;d:
## Define the intended direction of change (service loss/increased damage)
loss <- c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
gain <- c("Sed_export","N_export","C_Risk")

 combos = list(
    combo_1 = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    combo_2 = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  )
# after running:
hs <- extract_hotspots(
  df = plt_long,
  value_col = "pct_chg",
  pct_cutoff = 0.05,
  threshold_mode = "percent",
  rule_mode = "vectors",
  loss_services = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio"),
  gain_services = c("Sed_export","N_export","C_Risk"),
  combos = list(
    deg_combo = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    rec_combo = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  ),
  id_cols = c("c_fid"),
  sf_obj = sf_f,                                       # sf with fid
  write_sf_path = "output_data/hotspots_abs_ch.gpkg",       
  write_driver  = "GPKG",                              
  clean_names   = TRUE,
  fid_alias     = "fid_2",                             # duplicate fid only for the file
  drop_fid_on_write = TRUE                             # drop original fid on disk (keep in memory)
)


#save(hs, file=here("output_data", "hotspots_5.RData")) 
# hotspots_sf <- st_read('/Users/rodriguez/OneDrive - World Wildlife Fund, Inc/global_NCP/output_data/hotspots_5_final.gpkg')
hp_sf <- hs$hotspots_sf
hp_sf <- hp_sf %>% select(-ends_with("_pct_chg"))
```

# Masking

Whathappens here is that i mask each one of the outputs, and fix the names to try to get this to make morr sense, be more replicable/consitent and facilitate the plottting (already done), by masking each binary with the value for plotting. Nevertheless, i think there is a smarter way to do this and i should aske for advice.

```{r prelim fixing names}


mask_pct_change_by_hotspot <- function(hp_sf,
                                       services_keep = c("Nature_Access","N_export","N_retention",
                                                         "N_Ret_Ratio","Sed_export","USLE",
                                                         "Sed_Ret_Ratio","Rt_nohab",
                                                         "C_Risk","C_Prot_service",
                                                         "C_Risk_Red_Ratio","Pollination"),
                                       value_suffix_re = "(?:_abs_?chg)$",   # _pct_chg or _pctchg
                                       masked_suffix   = "_masked",
                                       verbose = TRUE) {
  stopifnot(inherits(hp_sf, "sf"))

  nm <- names(hp_sf)

  # find *_pct_chg / *_pctchg (case-insensitive)
  val_cols <- nm[str_detect(nm, regex(value_suffix_re, ignore_case = TRUE))]
  if (length(val_cols) == 0L) {
    if (verbose) message("No percent-change columns found. Nothing to mask.")
    return(hp_sf)
  }

  # stems (drop suffix; case-insensitive)
  stems <- tolower(str_remove(val_cols, regex(value_suffix_re, ignore_case = TRUE)))
  stems_nomean <- str_remove(stems, "_mean$")

  # map stems -> hotspot binary service names
  service_map <- c(
    "nature_access"   = "Nature_Access",
    "n_export"        = "N_export",
    "n_retention"     = "N_retention",
    "n_ret_ratio"     = "N_Ret_Ratio",
    "sed_export"      = "Sed_export",
    "usle"            = "USLE",
    "sed_ret_ratio"   = "Sed_Ret_Ratio",
    "pollination"     = "Pollination",
    "rt_nohab_mean"   = "Rt_nohab",
    "rt_nohab"        = "Rt_nohab",
    "rt_ratio_mean"   = "C_Risk_Red_Ratio",
    "rt_ratio"        = "C_Risk_Red_Ratio",
    "rt_service_mean" = "C_Prot_service",
    "rt_service"      = "C_Prot_service",
    "rt_mean"         = "C_Risk",
    "rt"              = "C_Risk"
  )

  svc_from_stem <- function(st) {
    if (!is.na(service_map[st])) as.character(service_map[st])
    else if (!is.na(service_map[str_remove(st, "_mean$")])) as.character(service_map[str_remove(st, "_mean$")])
    else NA_character_
  }
  services <- vapply(stems, svc_from_stem, FUN.VALUE = character(1))

  map_tbl <- tibble(
    val_col = val_cols,
    stem    = stems,
    service = services,
    bin_col = services  # binary cols named by service
  ) %>%
    filter(!is.na(service)) %>%
    { if (is.null(services_keep)) . else filter(., service %in% services_keep) } %>%
    filter(val_col %in% nm, bin_col %in% nm)

  if (nrow(map_tbl) == 0L) {
    if (verbose) message("No value↔binary pairs found to mask.")
    return(hp_sf)
  }

  for (i in seq_len(nrow(map_tbl))) {
    v   <- map_tbl$val_col[i]
    b   <- map_tbl$bin_col[i]
    out <- paste0(v, masked_suffix)

    hp_sf[[out]] <- ifelse(hp_sf[[b]] == 1L, as.numeric(hp_sf[[v]]), NA_real_)
    hp_sf <- hp_sf %>% relocate(all_of(out), .after = all_of(v))
  }

  if (verbose) message("Masked ", nrow(map_tbl), " layer(s): ", paste0(map_tbl$service, collapse = ", "))
  hp_sf
}


hp_sf <- mask_pct_change_by_hotspot(hp_sf)

# sanity check: see the new *_masked columns
names(hp_sf)[str_detect(names(hp_sf), "_abs_?chg_masked$")]
st_write(hp_sf, paste0(inpath, '/', 'hotspots_5_abs_mskd.gpkg'), append = FALSE)
         
```

### 2.1.1 Load Data

```{r load_plotting data res}

load(here("output_data", "hotspots_5.RData"))

hotspots_df<- hs$hotspots_df #plt_long 
inverse_df  <- hs$non_hotspots_df

all <- c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio","Sed_export","N_export","C_Risk")

inverse_df <- inverse_df %>% filter(service %in% all)
```

## 2.1 Hotspots

```{r scatterplot, fig.height=7, fig.width=12, warning=FALSE}
# Make names shorter
socio_labels <- c(
  "GHS_BUILT_S_E2020_mean" = "Built Area",
  "fields_mehrabi_2017_mean" = "Field Size",
  "hdi_raster_predictions_2020_mean" = "HDI",
  "rast_adm1_gini_disp_2020_mean" = "Income Inequality",
  "rast_gdpTot_1990_2020_30arcsec_2020_sum" = "GDP (Total)",
  "GHS_POP_E2020_GLOBE_sum" = "Population (GHS)",
  "GlobPOP_Count_30arc_2020_sum" = "Population (Global)"
)
files_hot_only <- plot_hotspot_density_bin2d(
  hotspots_df, inverse_df,
  socio_labels = socio_labels,
  which_layers = "hotspots",
  drop_services = "Rt_nohab",
  trim_p = c(0.01, 0.99),
  y_trim_p = c(0.01, 0.99),          # optional; helps if y is very skewed
  single_fill_limits = c(0.02, 0.98),
  single_limits_mode = "quantile",
  per_facet_stretch = TRUE,         # try TRUE to maximize local contrast
  run_id = "hot_only_q02_098",
  out_dir = "output_charts2",
  filename_suffix = "_bin2d_f_stretch.png"
)
```

## 2.2 Non- Hotpots

Not necessary to redo !!!!!

```{r plot 2, fig.height=7, fig.width=12, warning=FALSE}

files_bg_only <- plot_hotspot_density_bin2d(
  hotspots_df, inverse_df,
  socio_labels = socio_labels,
  which_layers = "nonhotspots",
  drop_services = "Rt_nohab",
  trim_p = c(0.01, 0.99),
  y_trim_p = c(0.01, 0.99),
  single_fill_limits = c(0.02, 0.98),
  single_limits_mode = "quantile",
  run_id = "nonhot_only_q02_098",
  out_dir = "output_charts2",
  filename_suffix = "_bin2d.png"
)

```

## 2.3 Hotspot-Not Hotspot Overlay.

```{r runh plot, fig.height=7, fig.width=12, warning=FALSE}



# 2) baseline run — global/service stretch, 2–98% quantiles
socio_labels <- c(
  "GHS_BUILT_S_E2020_mean" = "Built Area",
  "fields_mehrabi_2017_mean" = "Field Size",
  "hdi_raster_predictions_2020_mean" = "HDI",
  "rast_adm1_gini_disp_2020_mean" = "Income Inequality",
  "rast_gdpTot_1990_2020_30arcsec_2020_sum" = "GDP (Total)",
  "GHS_POP_E2020_GLOBE_sum" = "Population (GHS)",
  "GlobPOP_Count_30arc_2020_sum" = "Population (Global)"
)

files_hot_only <- plot_hotspot_density_bin2d(
  hotspots_df  = hotspots_df,
  inverse_df   = inverse_df,
  socio_labels = socio_labels,
  which_layers = "both",
  drop_services = "Rt_nohab",
  bg_bins = 80, hs_bins = 80,
  bg_alpha = 0.8, hs_alpha = 0.8,
  single_fill_limits = c(0.02, 0.98),
  single_limits_mode = "quantile",
  bg_palette = viridisLite::viridis(256, option = "C", begin = 0.1, end = 0.95),
  hs_palette = viridisLite::viridis(256, option = "B", begin = 0.2, end = 0.9),
  per_facet_stretch = FALSE,
  hs_contours = TRUE,                # <- try this
  run_id = "hot_only_q02_098",
  out_dir = "output_charts2",
  filename_suffix = "_bin2d_2scales.png"
)

```

```{r preset 2}

socio_labels <- c(
  "GHS_BUILT_S_E2020_mean" = "Built Area",
  "fields_mehrabi_2017_mean" = "Field Size",
  "hdi_raster_predictions_2020_mean" = "HDI",
  "rast_adm1_gini_disp_2020_mean" = "Income Inequality",
  "rast_gdpTot_1990_2020_30arcsec_2020_sum" = "GDP (Total)",
  "GHS_POP_E2020_GLOBE_sum" = "Population (GHS)",
  "GlobPOP_Count_30arc_2020_sum" = "Population (Global)"
)

  files_hot_only <- plot_hotspot_density_bin2d(
  hotspots_df  = hotspots_df,
  inverse_df   = inverse_df,
  socio_labels = socio_labels,
  which_layers = "both",
  drop_services = "Rt_nohab",
  trim_p = c(0.01, 0.99),
  y_trim_p = c(0.01, 0.99),
  bg_bins = 100, hs_bins = 75,
  bg_alpha = 0.6, hs_alpha = 0.95,
  single_fill_limits = c(0.02, 0.98),
  single_limits_mode = "quantile",
  bg_palette = viridisLite::viridis(256, option = "C", begin = 0.1, end = 0.95),
  hs_palette = viridisLite::viridis(256, option = "B", begin = 0.2, end = 0.9),
  per_facet_stretch = FALSE,
  hs_contours = TRUE,                # <- try this
  run_id = "hot_only_q02_098",
  out_dir = "output_charts2",
  filename_suffix = "_bin2d_2scales_facet.png"
)

```
