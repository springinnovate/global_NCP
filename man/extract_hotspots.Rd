% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/get_hotspots.R
\name{extract_hotspots}
\alias{extract_hotspots}
\title{Extract hotspots from long-format service-change data}
\usage{
extract_hotspots(
  df,
  value_col = "pct_chg",
  pct_cutoff = 0.05,
  n_cut = NULL,
  threshold_mode = c("percent", "count"),
  rule_mode = c("vectors", "explicit"),
  side = c("high", "low", "both"),
  loss_services = character(0),
  gain_services = character(0),
  combos = NULL,
  id_cols = NULL,
  sf_obj = NULL,
  write_sf_path = NULL,
  write_driver = "GPKG",
  clean_names = TRUE,
  fid_alias = "fid_2",
  drop_fid_on_write = TRUE
)
}
\arguments{
\item{df}{A data.frame (long format) with \code{service}, \code{fid}, and a numeric
change column (default \code{pct_chg}). May include additional ID cols.}

\item{value_col}{Name of numeric column used to rank (default "pct_chg").}

\item{pct_cutoff}{Percentile cutoff in (0,1] when \code{threshold_mode="percent"}.}

\item{n_cut}{Optional integer when \code{threshold_mode="count"}; number of rows
per service to keep at each side (top/bottom).}

\item{threshold_mode}{"percent" (default) or "count".}

\item{rule_mode}{"vectors" (default) or "explicit".}

\item{side}{When \code{rule_mode="explicit"}, choose "high", "low", or "both".}

\item{loss_services}{Character vector of services where decreases are desirable.}

\item{gain_services}{Character vector of services where increases are desirable.}

\item{combos}{Optional named list of character vectors, each listing services
that form a combo (e.g., \code{list(combo_1 = c("A","B"))}). Combo columns are
added to the summary and \code{hotspots_sf}.}

\item{id_cols}{Optional character vector of extra ID columns from \code{df} to carry
through summaries (e.g., \code{"c_fid"}). These are summarised with \code{dplyr::first()}.
They are \strong{not} duplicated into \code{hotspots_sf} if already present in \code{sf_obj}.}

\item{sf_obj}{Optional \code{sf} object containing a \code{fid} column to join results.
If supplied, an \code{hotspots_sf} is returned (and optionally written to disk).
\code{sf_obj} must have unique \code{fid}; duplicates error.}

\item{write_sf_path}{Optional file path to write the hotspot \code{sf} to disk.}

\item{write_driver}{GDAL driver (e.g., \code{"GPKG"}, \code{"ESRI Shapefile"}). Default "GPKG".}

\item{clean_names}{Logical; if \code{TRUE}, clean the \strong{new} attribute names
(binary and summary columns) for GIS friendliness (underscored, ASCII).}

\item{fid_alias}{Character or \code{NULL}. If non-NULL and \code{write_sf_path} is set,
duplicate \code{fid} to this alias \strong{only for the file on disk} (default \code{"fid_2"}).}

\item{drop_fid_on_write}{Logical; if \code{TRUE}, drop the original \code{fid} from the
on-disk file after aliasing. The returned \code{hotspots_sf} in R keeps \code{fid}.}
}
\value{
A list with:
\describe{
\item{hotspots_df}{per-row hotspots (long tibble)}
\item{non_hotspots_df}{complement (long tibble)}
\item{summary_df}{one row per fid with counts, types, combos, service list}
\item{binary_matrix}{wide binary service matrix by fid (hotspot fids only)}
\item{hotspots_sf}{\code{sf} with hotspot features + summary + wide binary columns (if \code{sf_obj} supplied)}
}
}
\description{
Identifies hotspots per service using percentile or fixed-count thresholds.
Two rule modes are supported:
\itemize{
\item \code{rule_mode = "vectors"}: services in \code{loss_services} are "good when low"
and services in \code{gain_services} are "good when high".
\item \code{rule_mode = "explicit"}: ignore loss/gain vectors and use \code{side}
("high", "low", or "both") for all services.
}
}
\details{
Returns per-row hotspot flags, the complement (non-hotspots), a per-\code{fid}
summary (count, types, combos, service list), a wide binary matrix (one
column per service), and (optionally) an \code{sf} with \strong{only the hotspot
features} that already includes the summary fields \strong{and} the wide
binary columns. When writing to disk, the function can \strong{duplicate} \code{fid}
into a safe alias (e.g., \code{fid_2}) and (optionally) \strong{drop} the original
\code{fid} on disk to avoid GDAL driver conflicts (e.g., Shapefile).
}
\examples{
\dontrun{
hs <- extract_hotspots(
  df = plt_long,
  value_col = "pct_chg",
  pct_cutoff = 0.05,
  threshold_mode = "percent",
  rule_mode = "vectors",
  loss_services = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio"),
  gain_services = c("Sed_export","N_export","C_Risk"),
  combos = list(
    deg_combo = c("Nature_Access","Pollination","N_export","Sed_export","C_Risk"),
    rec_combo = c("Nature_Access","Pollination","N_Ret_Ratio","Sed_Ret_Ratio","C_Risk_Red_Ratio")
  ),
  id_cols = c("c_fid"),
  sf_obj = sf_f,
  write_sf_path = "output_charts/hotspots.gpkg",
  write_driver  = "GPKG",
  clean_names   = TRUE,
  fid_alias = "fid_2",
  drop_fid_on_write = TRUE
)
}

}
