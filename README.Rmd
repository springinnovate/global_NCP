---
title: "README"
author: "Jeronimo Rodriguez Escobar"
output: github_document
---


##### ####

# Overview

This repository documents the development of a structured and scalable workflow to extract, analyze, and visualize **zonal summary statistics** from global **ecosystem service (ES)** and **land cover (LC)** raster datasets using meaningful spatial units such as hydrological basins, countries, income groups, or WWF biomes.

At its core, the workflow relies on the [`exactextractr`](https://github.com/isciences/exactextractr) package in R, which enables fast and precise zonal operations between raster and vector data. The extracted statistics are systematically attached to polygon geometries and exported for downstream use in GIS software, tabular analysis, or visualization.

Recent additions extend the functionality beyond two-date comparisons, introducing:

- **Multi-temporal analysis** of **Nitrogen Delivery Ratio (NDR)** using modeled outputs for 1992, 1995, 1998, 2001, and 2004.
- **Systematic land cover change analysis**, using square contingency matrices and change metrics from the [`diffeR`](https://cran.r-project.org/package=diffeR) package. These methods quantify not only the amount of change, but its structure — separating **gain**, **loss**, **persistence**, **exchange**, and **shift** 
- **Modular and parallelized functions** for batch-processing raster data across thousands of spatial units (e.g., HydroBASINS levels 6 and 7), minimizing memory overhead and improving reproducibility.

This framework supports early-stage exploration of ES and LC dynamics, with the potential to scale toward regular monitoring, hotspot detection, and distributional equity analysis across jurisdictions and social groups.

# Objectives

- Extract zonal summary statistics from global ES raster layers.
- Compute multi-year trends and **percent changes** in ES provision.
- Reclassify global land cover into **natural** and **transformed** categories and analyze change dynamics using square contingency matrices.
- Derive and summarize **components of land cover change** per unit (gain, persistence, loss, quantity, exchange, shift).
- Join outputs to spatial polygon datasets for export, visualization, or spatial modeling.



# Input Data

## Vector Layers
Polygon datasets can be loaded from local vector files (`.gpkg` format) or external sources such as **GADM**. Different spatial aggregations are considered: **continents, subregions, countries, biomes, watersheds**.

Vector data are stored in the `vector/` directory and include:

- Country-level boundaries
- WWF Biomes
- Income and WB region groups
- Hydrological units from [HydroSHEDS](https://www.hydrosheds.org/products/hydrobasins) (levels 6 and 7)

All layers are provided as `.gpkg` files.


## Raster Layers 


Raster inputs are located in 'input_ES/'. They represent global ES values modeled with InVEST, covering two key years (1992 and 2020), plus multi-year outputs (e.g., 1992–2004 for NDR). Each raster is labeled with: Ecosystem service name Year of modeling Units (e.g., kg/ha, people fed)

1.  Nitrogen Export. Derived from the Nitrogen retention modeled using the [**InVEST Nutrient Delivery Ratio**](http://data.naturalcapitalproject.org/invest-releases/3.5.0/userguide/ndr.html). Expressed in kg/pixel/year

2.  Sediment Retention. Derived using [**InVEST SDR: Sediment Delivery Ration**](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/sdr.html). Values in ton/pixel/year

3.  Soil Erosion derived using the *Revised Universal Soil Loss Equation-USLE*

4.  Pollination. Derived from [**InVEST SDR: Pollinator Abundance Model**](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/croppollination.html). Units represent Polllination Change in people fed on HABitat. More information in [**Chaplin-Kramer, et al. 2022**](https://static-content.springer.com/esm/art%3A10.1038%2Fs41559-022-01934-5/MediaObjects/41559_2022_1934_MOESM1_ESM.pdf)

5.  Coastal Protection. Unitless measure, refers to a derived vulnerability index. [**InVEST Coastal Vulnerability Model**](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/coastal_vulnerability.html)

6.  Nature Access represented as [**the number of people within 1 hour travel of natural and semi-natural lands**](https://github.com/springinnovate/distance-to-hab-with-friction) (Chaplin-Kramer et al, 2022).

Additionally, reclassified **ESA LC 300m** maps (1992–2020) are used for land cover change analysis. LC is simplified into two classes:

- 1: Transformed land (cropland, urban, etc.)
- 2: Natural land cover (forest, grassland, wetlands, etc.)



<p div style="display: flex; gap: 10px;">
  <img src="output_maps/OriginalServices_92.png" width="45%" style="margin-right: 10px;"/>
  <img src="output_maps/OriginalServices_2020.png" width="48%" />
</div>

# Differences

<p div style="display: flex; gap: 10px;">
  <img src="output_maps/OriginalServices_chg_1992_2020.png" style="margin-right: 10px;"/>
</div>
---

# Workflow Steps


## 1. Extract Zonal Summary Statistics for ES Rasters

Using `exactextractr`, compute mean values per polygon unit for each raster. This is repeated for 1992 and 2020 layers, then differences are calculated.

## 2. Analyze Change Over Time

For multi-year modeled outputs (e.g., NDR from 1992 to 2004), compute % change and trends per spatial unit. Results are stored in long format and pivoted as needed.



## 3. Land Cover Change Analysis Using Contingency Matrices

Land cover transitions are analyzed between successive dates using the `diffeR::crosstabm()` and `diffeR::diffTablej()` functions.

For each polygon (e.g., basin), we compute a **square contingency matrix** that summarizes pixel transitions between natural and transformed classes.

### Change Components Extracted

The following metrics are computed for each class and overall:

- **Gain**: % of area gained by the class
- **Persistence**: % that remained in the same class
- **Loss**: % of area lost to another class
- **Quantity**: Overall change due to size differences
- **Exchange**: Swaps between classes that cancel out
- **Shift**: Residual change not explained by Quantity or Exchange

These metrics are produced for each **polygon** and each **temporal transition** (e.g., 1992–1995, 1995–1998, ...).


### Example Output Table (Long Format)

| Category | Gain  | Persistence | Loss  | Quantity | Exchange | Shift | HYBAS_ID | year_step |
|----------|-------|-------------|-------|----------|----------|--------|-----------|------------|
| 1        | 0.004 | 0.441       | 0.000 | 0.004    | 0.000    | 0.000  | 1070000010 | 1995_1992 |
| 2        | 0.000 | 99.555      | 0.004 | 0.004    | 0.000    | 0.000  | 1070000010 | 1995_1992 |
| Overall  | 0.004 | 99.996      | 0.004 | 0.004    | 0.000    | 0.000  | 1070000010 | 1995_1992 |

### Example Pivoted Output for Export


```r
lcc_metrics_wide <- lcc_metrics_df %>%
  pivot_wider(
    id_cols = c(HYBAS_ID),
    names_from = c(Category, year_step),
    values_from = c(Gain, Persistence, Loss, Quantity, Exchange, Shift),
    names_glue = "{.value}_{Category}_{year_step}"
  )
```

Join to polygons and export:

```r
basins_export <- left_join(basins, lcc_metrics_wide, by = "HYBAS_ID")
st_write(basins_export, "vector/basins.gpkg", layer = "lcc_change_metrics", append = FALSE)
```


---

# Visualization & Interpretation

Bar plots and faceted maps are created using `ggplot2`. Changes can be visualized per service or per transition.



![](outputs/es_change_barplot.png)

Additional interpretation tools include:

- Top/bottom change filters by service or region
- Longitudinal comparisons across basins
- Potential use in equity/distributional analyses

---

# Future Directions

- Add more refined LC classes and extend beyond binary classification
- Integrate InVEST model output pipelines for continuous updates
- Automate report generation with `rmarkdown::render()`
- Integrate a Shiny dashboard or QGIS-compatible plugin

---

# License

MIT License

# Author

**Jeronimo Rodriguez-Escobar**  
Primary author and developer


For questions or contributions, please [open an issue](https://github.com/springinnovate/global_NCP/issues) or submit a pull request.



