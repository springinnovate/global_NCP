---
title: "Beneficiary consolidation
output: html_notebook
---

# GDP (Kummu)
ANALYSIS_DATA = {
  ("rast_gdpTot_1990_2020_30arcsec", 1990): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 1,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 1995): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 2,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 2000): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 3,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 2005): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 4,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 2010): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 5,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 2015): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 6,
  },
  ("rast_gdpTot_1990_2020_30arcsec", 2020): {
    "path": "./data/analysis/Gridded_GDP/rast_gdpTot_1990_2020_30arcsec.tif",
    "band": 7,
  },
}


# GHS_POP
ANALYSIS_DATA = {
  ("GHS_POP_E1990_GLOBE_R2023A_54009_100_V1_0", 1990): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E1990_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E1995_GLOBE_R2023A_54009_100_V1_0", 1995): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E1995_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2000_GLOBE_R2023A_54009_100_V1_0", 2000): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2000_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2005_GLOBE_R2023A_54009_100_V1_0", 2005): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2005_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2010_GLOBE_R2023A_54009_100_V1_0", 2010): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2010_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2015_GLOBE_R2023A_54009_100_V1_0", 2015): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2015_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2020_GLOBE_R2023A_54009_100_V1_0", 2020): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2020_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
}


# GHS_POP 3 SS
ANALYSIS_DATA = {
  ("GHS_POP_E1990_GLOBE_R2023A_4326_3ss_V1_0", 1990): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E1990_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E1995_GLOBE_R2023A_4326_3ss_V1_0", 1995): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E1995_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2000_GLOBE_R2023A_4326_3ss_V1_0", 2000): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2000_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2005_GLOBE_R2023A_4326_3ss_V1_0", 2005): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2005_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2010_GLOBE_R2023A_4326_3ss_V1_0", 2010): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2010_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2015_GLOBE_R2023A_4326_3ss_V1_0", 2015): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2015_GLOBE_R2023A_54009_100_V1_0.tif",
    "band": 1,
  },
  ("GHS_POP_E2020_GLOBE_R2023A_4326_3ss_V1_0", 2020): {
    "path": "./data/analysis/GHS_POP/GHS_POP_E2020_GLOBE_R2023A_4326_3ss_V1_0.tif",
    "band": 1,
  },
}




# GlobPOP
ANALYSIS_DATA = {
  ("GlobPOP_Count_30arc_1990_I32", 1990): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_1990_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_1995_I32", 1995): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_1995_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_2000_I32", 2000): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_2000_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_2005_I32", 2005): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_2005_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_2010_I32", 2010): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_2010_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_2015_I32", 2015): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_2015_I32.tif",
    "band": 1,
  },
  ("GlobPOP_Count_30arc_2020_I32", 2020): {
    "path": "./data/analysis/GlobPOP/GlobPOP_Count_30arc_2020_I32.tif",
    "band": 1,
  },
}

# GGRidded HDI

ANALYSIS_DATA = {
  ("hdi_raster_predictions_2012", 2012): {
    "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2012.tif",
    "band": 1,
  },
  ("hdi_raster_predictions_2013", 2013): {
    "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2013.tif",
    "band": 1,
  },
    ("hdi_raster_predictions_2013", 2013): {
      "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2013.tif",
      "band": 1,
    },
      ("hdi_raster_predictions_2014", 2014): {
        "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2014.tif",
        "band": 1,
      },
      ("hdi_raster_predictions_2015", 2015): {
        "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2015.tif",
        "band": 1,
      },
    ("hdi_raster_predictions_2016", 2016): {
      "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2016.tif",
      "band": 1,
    },
      ("hdi_raster_predictions_2017", 2017): {
        "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2017.tif",
        "band": 1,
      },
        ("hdi_raster_predictions_2018", 2018): {
          "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2018.tif",
          "band": 1,
        },
          ("hdi_raster_predictions_2019", 2019): {
            "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2019.tif",
            "band": 1,
          },
    ("hdi_raster_predictions_2020", 2020): {
      "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2020.tif",
      "band": 1,
    },
      ("hdi_raster_predictions_2021", 2021): {
        "path": "./data/analysis/Gridded_HDI/hdi_raster_predictions_2021.tif",
        "band": 1,
      },
}



```{r load procesed data and build final gpkgs}

inpath <- here("summary_pipeline_workspace")

gp <- list.files(inpath, pattern = ".gpkg")

gp <- file.path(inpath, gp)

synth <- lapply(gp, st_read)
synth <- lapply(synth, function(s){
  s <- s %>% mutate(fid=row_number()-1)
})

synth <- lapply(synth, function(s){
  s <- st_drop_geometry(s)
})

synth[[1]] <- select(synth[[1]], fid, GHS_BUILT_S_E2020_GLOBE_R2023A_4326_3ss_V1_0_mean)
synth[[2]] <- select(synth[[2]], fid, rast_gdpTot_1990_2020_30arcsec.7_mean)
synth[[3]] <- select(synth[[3]], fid, GHS_POP_E2020_GLOBE_R2023A_4326_3ss_V1_0.1_mean)
synth[[4]] <- select(synth[[4]], fid, GlobPOP_Count_30arc_2020_I32.1_sum)
synth[[5]] <- select(synth[[5]], fid, hdi_raster_predictions_2020.1_mean)
synth[[6]] <- select(synth[[6]], fid,farmsize_mehrabi.1_mean)


synth <- reduce(synth, left_join, by= "fid")
# Load the polygons with the calcualted ES change variables
synth_ES <- st_read(here('vector',"hydrosheds_lv6_synth.gpkg"))
# Keep the columns of interest (original hydrosheds and pct_ch in this case)
synth_ES <- dplyr::select(synth_ES, 1:13, contains("pct_ch"))

synth_ES <- synth_ES %>% mutate(fid = row_number()-1)


synth_ES <- left_join(synth_ES, synth, by = 'fid')
synth_ES$fid <- NULL

st_write(synth_ES, here('vector', "hydrosheds_lv6_synth.gpkg"), layer = "benef_analysis", append = TRUE)

```


```{r pivot and preprare to plot the data}





```

